{% load l10n %}
{% load i18n %}
{% load comments %}
{% load comments_xtd %}

{% for item in comments %}
<li class="comment">
    <div class="vcard bio">
        <a name="c{{ item.comment.id }}"></a>
        {{ item.comment.user_email|xtd_comment_gravatar }}
    </div>
    <div class="comment-body">
        <div>
            <div class="d-flex">
                <h3>
                    {% if item.comment.url and not item.comment.is_removed %}
                    <a href="{{ item.comment.url }}" target="_new">
                        {% endif %}{{ item.comment.name }}{% if item.comment.url %}</a>
                    {% endif %}
                </h3>
                <div>
                    {% if item.comment.user and item.comment.user|has_permission:"django_comments.can_moderate" %}&nbsp;
                    <small class="badge badge-pill badge-secondary">{% trans "moderator" %}</small>
                    {% endif %}
                    <a class="ml-2" data-toggle="tooltip" title="{% trans 'comment permalink' %}"
                        href="{% get_comment_permalink item.comment %}">Â¶</a>
                </div>
                <div class="ml-5">
                    {% if not item.comment.is_removed %}
                    {% if allow_flagging and item.flagged %}
                    <small class="icon-flag text-danger mr-1" data-toggle="tooltip"
                        title="{% trans 'comment flagged' %}"></small>
                    {% if perms.comments.can_moderate %}
                    {% if item.flagged_count %}
                    <small class="mr-1 text-white" data-toggle="tooltip"
                        title="{% blocktrans count counter=item.flagged_count %}A user has flagged this comment as inappropriate.{% plural %}{{ counter }} users have flagged this comment as inappropriate.{% endblocktrans %}">{{ item.flagged_count }}</small>
                    {% endif %}
                    {% endif %}
                    {% elif allow_flagging %}
                    <a class="text-muted small mr-1" href="{% url 'comments-flag' item.comment.pk %}">
                        <span class="icon-flag" data-toggle="tooltip" title="{% trans 'flag comment' %}"></span></a>
                    {% endif %}
                    {% if perms.comments.can_moderate %}
                    <a class="text-muted small ml-2" href="{% url 'comments-delete' item.comment.pk %}">
                        <span class="icon-trash" data-toggle="tooltip" title="{% trans 'remove comment' %}"></span></a>
                    {% endif %}
                    {% endif %}
                </div>
            </div>
            <div class="meta">{{ item.comment.submit_date|localize }}</div>
            {% if item.comment.is_removed %}
            <p class="text-muted{% if not allow_feedback and not item.comment.allow_thread %} pb-3{% endif %}">
                <em>{% trans "This comment has been removed." %}</em></p>
            {% else %}
            <p>
                {% include "includes/django_comments_xtd/comment_content.html" with content=item.comment.comment %}
            </p>
            <p>
                {% if allow_feedback %}
                {% include "includes/django_comments_xtd/user_feedback.html" %}
                {% endif %}
                {% if item.comment.allow_thread and not item.comment.is_removed %}
                {% if allow_feedback %}
                <span class="text-muted"></span>
                {% endif %}
                <a href="{{ item.comment.get_reply_url }}" class="reply ml-3">{% trans "reply" %}</a>
                {% endif %}
            </p>
            {% endif %}
        </div>
        <ul class="children">
            {% if not item.comment.is_removed and item.children %}
            {% render_xtdcomment_tree with comments=item.children %}
            {% endif %}
        </ul>
</li>

{% endfor %}