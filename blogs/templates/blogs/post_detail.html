{% extends 'base.html' %}
{% load static %}
{% load crispy_forms_tags %}

{% block head_title %}{{ post.title }}{% endblock %}

{% block content %}
<style>
    .post-body img {
        width: 100%
    }
</style>

<section class="ftco-section">
    <div class="container mt-5">
        <div class="row justify-content-center mb-5 pb-5">
            <div class="col-md-7 text-center heading-section">
                <a href="{% url 'post-list' %}" class="text-secondary"><span>Blog</span></a>
                <h2 class="text-lowercase">
                    <a href="{{ post.category.get_category_url }}" class="text-white">{{ post.category }}</a>
                </h2>
            </div>
        </div>
        <div class="row d-flex justify-content-center">
            <div class="col-md-8">
                <h2 class="mb-3">{{ post.title }}</h2>
                {{ post.content|safe }}
                <div class="tag-widget post-tag-container mb-5 mt-5">
                    <div class="tagcloud">
                        {% for tag in post.tags.all %}
                        <a href="{{ tag.get_tag_url }}" class="tag-cloud-link">{{ tag }}</a>
                        {% endfor %}
                        {% if user.is_staff %}
                        <a href="{% url 'post-update' slug=post.slug %}" class="text-white">
                            <span class="icon-edit"></span>
                        </a>
                        <a href="{% url 'post-delete' slug=post.slug %}" class="text-danger">
                            <span class="icon-trash"></span>
                        </a>
                        {% endif %}
                    </div>
                    <form class="like-form" action="" method="POST" id="{{ post.id }}">
                        {% csrf_token %}
                        <input type="hidden" name="post_id" id="post_id" value="{{ post.id }}">
                        <button class="btn like-btn{{ post.id }}" type="submit">
                            {% if profile not in post.liked.all %}
                            <span class="">
                                <ion-icon name="thumbs-up-sharp"></ion-icon> Like
                            </span>
                            {% else %}
                            <span class="text-danger">
                                <ion-icon name="thumbs-down-sharp"></ion-icon> Unlike
                            </span>
                            {% endif %}
                        </button>
                    </form>
                </div>

                <div class="about-author d-flex pt-5">
                    <div class="bio align-self-md-center mr-4">
                        <img src="{{ post.author.avatar.url }}" alt="{{ post.author }}" class="img-fluid mb-4">
                    </div>
                    <div class="desc align-self-md-center">
                        <h3>About The Author</h3>
                        <p>Lorem ipsum dolor sit amet, consectetur adipisicing elit. Ducimus itaque, autem
                            necessitatibus voluptate
                            quod mollitia delectus aut, sunt placeat nam vero culpa sapiente consectetur similique,
                            inventore eos
                            fugit cupiditate numquam!</p>
                    </div>
                </div>


                {% if not post.restrict_comment %}
                {% include 'comments.html' %}
                {% else %}
                <div class="pt-5 mt-5">
                    <div class="comment text-center">
                        <em>comments are restricted</em>
                    </div>
                </div>
                {% endif %}
            </div> <!-- .col-md-8 -->

        </div>

    </div>
</section>
{% endblock %}


{% block extra_body %}
<script>
    $(document).ready(function () {
        $('.like-form').submit(function (e) {
            e.preventDefault()

            const post_id = $(this).attr('id')
            const likeText = $(`.like-btn${post_id}`).text()
            const trim = $.trim(likeText)
            const url = $('.like-form').attr('action')

            $.ajax({
                type: 'POST',
                url: url,
                data: {
                    'csrfmiddlewaretoken': $('input[name=csrfmiddlewaretoken]').val(),
                    'post_id': post_id,
                },
                success: function () {
                    // console.log(data);

                    $.ajax({
                        type: 'GET',
                        url: 'http://127.0.0.1:8000/serialized/',
                        success: function (response) {
                            $.each(response, function (index, element) {
                                if (post_id == element.id) {
                                    if (trim == 'Like') {
                                        $(`.like-btn${post_id}`).html(
                                            `<span class="text-danger"><ion-icon name="thumbs-down-sharp"></ion-icon> Unlike</span>`
                                            )
                                    } else if (trim == 'Unlike') {
                                        $(`.like-btn${post_id}`).html(
                                            `<span class=""><ion-icon name="thumbs-up-sharp"></ion-icon> Like</span>`
                                            )
                                    } else {
                                        console.log('ups');
                                    }
                                }
                            })
                        },
                        error: function (error) {
                            console.log('error');
                        }
                    })

                },
                error: function (error) {
                    console.log('error', error);
                },
            })
        })
    })
</script>
{% endblock %}