{% extends 'base.html' %}
{% load static %}
{% load crispy_forms_tags %}

{% block head_title %}{{ post.title }}{% endblock %}

{% block content %}
<style>
    .post-body img {
        width: 100%
    }
</style>

<section class="ftco-section">
    <div class="container mt-5">
        <div class="row justify-content-center mb-5 pb-5">
            <div class="col-md-7 text-center heading-section">
                <a href="{% url 'post-list' %}" class="text-secondary"><span>Blog</span></a>
                <h2 class="text-lowercase">
                    <a href="{{ post.category.get_category_url }}" class="text-white">{{ post.category }}</a>
                </h2>
            </div>
        </div>
        <div class="row d-flex justify-content-center">
            <div class="col-md-8">
                <h2 class="mb-3">{{ post.title }}</h2>
                {{ post.content|safe }}
                <div class="tag-widget post-tag-container mb-5 mt-5">
                    <div class="tagcloud">
                        {% for tag in post.tags.all %}
                        <a href="{{ tag.get_tag_url }}" class="tag-cloud-link">{{ tag }}</a>
                        {% endfor %}
                        {% if user.is_staff %}
                        <a href="{% url 'post-update' slug=post.slug %}" class="text-white">
                            <span class="icon-edit"></span>
                        </a>
                        <a href="{% url 'post-delete' slug=post.slug %}" class="text-danger">
                            <span class="icon-trash"></span>
                        </a>
                        {% endif %}
                    </div>
                    <div id="like-section">
                        <!-- {% include 'blogs/like_section.html' %} -->
                        <button class="ui button"
                            onclick="handlePostActionBtn('{{ post.id }}', '{{ post.likes.count }}','like')">{{ post.likes.count }}
                            Likes</button>
                        <button class="ui red button"
                            onclick="handlePostActionBtn('{{ post.id }}', '{{ post.likes.count }}','unlike')">
                            Unlike</button>
                    </div>
                </div>

                <div class="about-author d-flex pt-5">
                    <div class="bio align-self-md-center mr-4">
                        <img src="{{ post.author.avatar.url }}" alt="{{ post.author }}" class="img-fluid mb-4">
                    </div>
                    <div class="desc align-self-md-center">
                        <h3>About The Author</h3>
                        <p>Lorem ipsum dolor sit amet, consectetur adipisicing elit. Ducimus itaque, autem
                            necessitatibus voluptate
                            quod mollitia delectus aut, sunt placeat nam vero culpa sapiente consectetur similique,
                            inventore eos
                            fugit cupiditate numquam!</p>
                    </div>
                </div>


                {% if not post.restrict_comment %}
                {% comment %} {% include 'blogs/comments.html' %} {% endcomment %}
                {% else %}
                <div class="pt-5 mt-5">
                    <div class="comment text-center">
                        <em>comments are restricted</em>
                    </div>
                </div>
                {% endif %}
            </div> <!-- .col-md-8 -->

        </div>

    </div>
</section>
{% endblock %}


{% block extra_body %}

<script type="text/javascript"
    src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.4/MathJax.js?config=TeX-AMS_HTML"></script>
<script>
    var pres = document.querySelectorAll("pre>code");
    for (var i = 0; i < pres.length; i++) {
        hljs.highlightBlock(pres[i]);
    }
    // add HighlightJS-badge (options are optional)
    var options = { // optional
        // base content CSS selector that is searched for snippets
        contentSelector: "body",

        loadDelay: 0,

        // CSS class(es) used to render the copy icon.
        copyIconClass: "copy icon",
        // CSS class(es) used to render the done icon.
        checkIconClass: "check icon green",

    };
    window.highlightJsBadge(options);



    //    $(document).ready(function (e) {
    //        $(document).on('click', '#like', function (e) {
    //            e.preventDefault();
    //            const pk = $(this).attr('value')
    //            const url = $('.like-form').attr('action')
    //            $.ajax({
    //                type: 'POST',
    //                url: url,
    //                data: {
    //                    'csrfmiddlewaretoken': '{{ csrf_token }}',
    //                    'id': pk,
    //                },
    //                dataType: 'json',
    //                success: function (response) {
    //                    $('#like-section').html(response['form'])
    //                    console.log($('#like-section').html(response['form']));
    //                },
    //                error: function (rs, e) {
    //                    console.log(re.responseText);
    //                }
    //            })
    //        })
    //    })
    function getCookie(name) {
        let cookieValue = null;
        if (document.cookie && document.cookie !== '') {
            const cookies = document.cookie.split(';');
            for (let i = 0; i < cookies.length; i++) {
                const cookie = cookies[i].trim();
                // Does this cookie string begin with the name we want?
                if (cookie.substring(0, name.length + 1) === (name + '=')) {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                    break;
                }
            }
        }
        return cookieValue;
    }
    const csrftoken = getCookie('csrftoken');

    function handlePostActionBtn(post_id, currentCount, action) {
        console.log(post_id, currentCount)
        const url = "/api/posts/action"
        const method = "POST"
        const data = JSON.stringify({
            id: post_id,
            action: action
        })
        const xhr = new XMLHttpRequest();
        const csrftoken = getCookie('csrftoken');
        xhr.open(method, url)
        xhr.setRequestHeader("Content-Type", "application/json")
        xhr.setRequestHeader("HTTP_X_REQUESTED_WITH", "XMLHttpRequest")
        xhr.setRequestHeader("X-Requested-With", "XMLHttpRequest")
        xhr.setRequestHeader("X-CSRFToken", csrftoken)
        xhr.onload = function () {
            console.log(xhr.status, xhr.response);
        }
        // console.log(xhr.send(data));

        xhr.send(data)
        return
    }
</script>
{% endblock %}